<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Map Columns</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root {
            --pico-primary: #007bff;
            --pico-primary-hover: #0069d9;
            --pico-primary-focus: rgba(0, 123, 255, 0.25);
        }
        main { padding-top: 2rem; }
        .flash { background-color: #f8d7da; color: #721c24; padding: 1rem; border-radius: 0.25rem; margin-bottom: 1rem; }

        :root {
          --bg: #fff;
          --text: #222;
        }
        [data-theme="dark"] {
          --bg: #222;
          --text: #fff;
        }
        body {
          background: var(--bg);
          color: var(--text);
          transition: background 0.2s, color 0.2s;
        }
        button.theme-toggle {
          position: fixed;
          top: 10px;
          right: 10px;
          z-index: 1000;
          width: 2in;
          height: 0.5in;
          font-size: 0.9rem;
          padding: 0.1em 0.2em;
          line-height: 1.1;
          white-space: normal;
          max-width: 2in;
          overflow: hidden;
          text-align: center;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <main class="container">
        <article>
            <div style="background-color: #eaf4ff; border: 1px solid #b6d6f6; box-shadow: 0 2px 8px rgba(0,123,255,0.08); padding: 32px 0 24px 0; border-radius: 16px; margin-bottom: 32px;">
                <hgroup>
                    <h1 style="color: #111827; margin: 0 0 8px 0; font-size: 2.5em; font-weight: bold; text-align: center;">Map Columns and Define Key</h1>
                    <h2 style="color: #6b7280; text-align: center; font-weight: normal;">Match your CSV data to the Smartsheet columns</h2>
                </hgroup>
            </div>

            <!-- Docketwise-Smartsheet Integration Image -->
            <img src="{{ url_for('static', filename='images/integration.png') }}" alt="Docketwise to Smartsheet" style="width:50%; height:auto; display:block; margin:auto;">

            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <div class="flash">{{ messages[0] }}</div>
                {% endif %}
            {% endwith %}

            <!-- Back Button -->
            <button onclick="window.history.back()" style="margin:10px 0;">Back</button>

            <form action="/update" method="post" onsubmit="showProgress()">
                <input type="hidden" name="access_token" value="{{ access_token }}">
                <input type="hidden" name="sheet_id" value="{{ sheet_id }}">
                <input type="hidden" name="filename" value="{{ filename }}">
                
                <details open>
                    <summary><strong>Step 1: Select Unique Identifier Column</strong></summary>
                    <p><small>Choose the column from your CSV used to check for existing rows (e.g., email, ID number).</small></p>
                    <select name="unique_identifier" required>
                        <option value="" disabled selected>-- Choose a column --</option>
                        {% for col in csv_cols %}
                            <option value="{{ col }}">{{ col }}</option>
                        {% endfor %}
                    </select>
                </details>

                <hgroup>
                    <h3>Step 2: Map Columns for Update/Insert</h3>
                    <p><small>Match CSV columns to Smartsheet columns. Leave as "Do not map" to ignore a column.</small></p>
                </hgroup>
                
                <table>
                    <thead>
                        <tr>
                            <th scope="col">CSV Column</th>
                            <th scope="col">Smartsheet Column</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for col in csv_cols %}
                        <tr>
                            <td><strong>{{ col }}</strong></td>
                            <td>
                                <select name="map_{{ col }}">
                                    <option value="">Do not map</option>
                                    {% for s_col, s_id in smartsheet_cols.items() %}
                                        <option value="{{ s_id }}" {% if auto_mapping[col] == s_id %}selected{% endif %}>{{ s_col }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <button type="submit">Update Smartsheet</button>
            </form>

            <div id="progress-message" style="display:none; margin-top:1em; text-align:center;">
              <span>Processing records, please wait...</span>
              <div class="spinner" style="margin:1em auto; width:40px; height:40px; border:4px solid #eee; border-top:4px solid #007bff; border-radius:50%; animation: spin 1s linear infinite;"></div>
            </div>
        </article>
    </main>

    <button class="theme-toggle" onclick="toggleTheme()">Toggle Light/Dark<br>Mode</button>

    <script>
    // Theme toggle logic
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
    }
    function toggleTheme() {
      const current = localStorage.getItem('theme') || 'light';
      setTheme(current === 'light' ? 'dark' : 'light');
    }
    window.onload = function() {
      const saved = localStorage.getItem('theme') || 'light';
      setTheme(saved);
    };

    function showProgress() {
      document.getElementById('progress-message').style.display = 'block';
    }
    </script>
</body>
</html>